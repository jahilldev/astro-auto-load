---
/**
 * Example Story Component with auto-loading
 * 
 * This component demonstrates:
 * 1. Defining a loader function that fetches data
 * 2. Accessing route parameters
 * 3. Automatic type inference from the loader
 */
import { getData, type Loader } from 'astro-auto-load/runtime';

// Define the loader - this runs BEFORE the page renders
export const load = async (ctx) => {
  const storyId = ctx.params.id;
  
  // Use the dedupe helper to prevent duplicate fetches
  return ctx.dedupe(
    async (id: string) => {
      const res = await fetch(`https://api.example.com/stories/${id}`);
      if (!res.ok) throw new Error('Story not found');
      return res.json() as Promise<{
        id: string;
        title: string;
        body: string;
        author: string;
        createdAt: string;
      }>;
    },
    storyId
  );
};

// Type is automatically inferred from the loader!
const story = getData<Loader<typeof load>>(Astro, import.meta.url);
---

{story ? (
  <article class="story">
    <header>
      <h1>{story.title}</h1>
      <p class="meta">
        By {story.author} â€¢ {new Date(story.createdAt).toLocaleDateString()}
      </p>
    </header>
    <div class="body">
      {story.body}
    </div>
  </article>
) : (
  <p>Story not found</p>
)}

<style>
  .story {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  .story header {
    margin-bottom: 2rem;
  }
  
  .story h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }
  
  .meta {
    color: #666;
    font-size: 0.9rem;
  }
  
  .body {
    line-height: 1.6;
  }
</style>

